# pivot_커뮤니티 WUB 시트 ARRAYFORMULA 자동 수식 가이드

## 📋 개요

Apps Script 없이 **ARRAYFORMULA**를 사용하여 행이 추가될 때마다 자동으로 계산되도록 할 수 있습니다. 각 열의 시작 행에 한 번만 수식을 입력하면 자동으로 아래 행까지 확장됩니다.

---

## 🎯 적용할 수식

### ⚠️ 중요: 전주 대비 계산의 한계

전주 대비 계산(H, Q, S열)은 각 행이 이전 행을 참조해야 하므로 **ARRAYFORMULA로는 완벽하게 구현하기 어렵습니다**. 

**대안**: 
1. **각 행에 개별 수식 유지** (현재 방식) - 가장 확실함
2. **ARRAYFORMULA + 수동 확장** - 시작 행에만 입력하고 드래그로 확장
3. **Apps Script 사용** - 완전 자동화

아래는 **합계 계산(O, P, U열)에 최적화된 ARRAYFORMULA**와 **전주 대비 계산을 위한 개선된 방법**을 제공합니다.

---

### H열: WoW(pv) - 전주 대비 변화율

**방법 1: ARRAYFORMULA (제한적, 권장하지 않음)**
```excel
=ARRAYFORMULA(IF(ROW(C3:C)<=2, "", IF(C3:C="", "", IF(INDEX(C:C, ROW(C3:C)-1)=0, "", C3:C/INDEX(C:C, ROW(C3:C)-1)-1))))
```

**방법 2: 개별 수식 + 자동 채우기 (권장)**
- H3 셀에: `=IF(C3="", "", IF(C2=0, "", C3/C2-1))`
- H3 셀을 선택하고 Ctrl+Shift+아래 화살표로 마지막 행까지 선택
- Ctrl+D로 수식 복사

**방법 3: 수식 템플릿 (가장 실용적)**
- H3에 수식 입력 후, H3 셀을 복사
- H열 전체 범위 선택 후 붙여넣기
- Google Sheets가 자동으로 행 번호를 조정합니다

---

### O열: 커뮤니티 WUB - 합계

**위치**: O10 셀에 입력

```excel
=ARRAYFORMULA(IF(ROW(B10:B)<=9, "", B10:B+K10:K))
```

**설명**: 10행부터 시작하여 B열과 K열을 더합니다.

---

### P열: 커뮤니티 WPV - 합계

**위치**: P2 셀에 입력

```excel
=ARRAYFORMULA(IF(ROW(C2:C)<=1, "", C2:C+L2:L))
```

**설명**: 2행부터 시작하여 C열과 L열을 더합니다.

---

### Q열: WoW(wub) - 전주 대비 변화율

**방법 1: ARRAYFORMULA (제한적)**
```excel
=ARRAYFORMULA(IF(ROW(O3:O)<=2, "", IF(O3:O="", "", IF(INDEX(O:O, ROW(O3:O)-1)=0, "", O3:O/INDEX(O:O, ROW(O3:O)-1)-1))))
```

**방법 2: 개별 수식 (권장)**
- Q3 셀에: `=IF(O3="", "", IF(O2=0, "", O3/O2-1))`
- Q3 셀을 복사하여 Q열 전체에 붙여넣기

---

### S열: WoW(wpv) - 전주 대비 변화율

**방법 1: ARRAYFORMULA (제한적)**
```excel
=ARRAYFORMULA(IF(ROW(P14:P)<=13, "", IF(P14:P="", "", IF(INDEX(P:P, ROW(P14:P)-1)=0, "", P14:P/INDEX(P:P, ROW(P14:P)-1)-1))))
```

**방법 2: 개별 수식 (권장)**
- S14 셀에: `=IF(P14="", "", IF(P13=0, "", P14/P13-1))`
- S14 셀을 복사하여 S열 전체에 붙여넣기

---

### U열: 전체 WUB 대비(커뮤니티) - 비율

**위치**: U2 셀에 입력

```excel
=ARRAYFORMULA(IF(ROW(AA2:AA)<=1, "", IF(AA2:AA="", "", IF(X2:X=0, "", AA2:AA/X2:X))))
```

**설명**: 2행부터 시작하여 AA열을 X열로 나눈 비율을 계산합니다.

---

## 📝 적용 방법

### 방법 A: ARRAYFORMULA 사용 (합계 계산에 적합)

#### 1단계: 기존 수식 삭제
각 열의 기존 수식을 삭제합니다 (합계 계산 열: O, P, U)

#### 2단계: ARRAYFORMULA 수식 입력
1. **O10** 셀에: `=ARRAYFORMULA(IF(ROW(B10:B)<=9, "", B10:B+K10:K))`
2. **P2** 셀에: `=ARRAYFORMULA(IF(ROW(C2:C)<=1, "", C2:C+L2:L))`
3. **U2** 셀에: `=ARRAYFORMULA(IF(ROW(AA2:AA)<=1, "", IF((AA2:AA="")+(X2:X="")+(X2:X=0), "", AA2:AA/X2:X)))`

#### 3단계: 전주 대비 계산 (H, Q, S열)
각 열의 시작 행에 개별 수식을 입력하고 복사:
1. **H3** 셀에: `=IF(C3="", "", IF(C2=0, "", C3/C2-1))` → H열 전체에 복사
2. **Q3** 셀에: `=IF(O3="", "", IF(O2=0, "", O3/O2-1))` → Q열 전체에 복사
3. **S14** 셀에: `=IF(P14="", "", IF(P13=0, "", P14/P13-1))` → S열 전체에 복사

---

### 방법 B: 개별 수식 + 자동 채우기 (가장 확실함)

#### 1단계: 각 열의 시작 행에 수식 입력
1. **H3**: `=IF(C3="", "", IF(C2=0, "", C3/C2-1))`
2. **O10**: `=B10+K10`
3. **P2**: `=C2+L2`
4. **Q3**: `=IF(O3="", "", IF(O2=0, "", O3/O2-1))`
5. **S14**: `=IF(P14="", "", IF(P13=0, "", P14/P13-1))`
6. **U2**: `=IF(AA2="", "", IF(X2=0, "", AA2/X2))`

#### 2단계: 수식 자동 확장
각 열의 시작 행 셀을 선택하고:
- **Ctrl+Shift+아래 화살표**: 마지막 행까지 선택
- **Ctrl+D**: 수식 복사 (Windows) 또는 **Cmd+D** (Mac)

또는:
- 시작 행 셀을 복사 (Ctrl+C)
- 해당 열의 전체 범위 선택 후 붙여넣기 (Ctrl+V)
- Google Sheets가 자동으로 행 번호를 조정합니다

#### 3단계: 새 행 추가 시
새 행을 추가하면:
1. 위의 수식을 복사하여 새 행에 붙여넣기
2. 또는 시작 행의 수식을 드래그하여 확장

---

### 방법 C: 수식 템플릿 시트 활용 (고급)

별도 시트에 수식 템플릿을 만들어두고 필요할 때 복사하여 사용할 수 있습니다.

---

## ⚠️ 주의사항

### 1. 수식 충돌 방지

- 기존에 각 행에 개별 수식이 있다면, 먼저 삭제한 후 ARRAYFORMULA를 입력해야 합니다
- ARRAYFORMULA는 범위 전체를 덮어쓰므로, 부분적으로만 적용할 수 없습니다

### 2. 성능 고려

- ARRAYFORMULA는 대량의 데이터에서도 잘 작동하지만, 매우 큰 범위(수만 행)에서는 성능이 느려질 수 있습니다
- 필요한 범위만 지정하는 것이 좋습니다 (예: `C3:C1000` 대신 `C3:C`)

### 3. 오류 처리

- 위 수식들은 빈 셀이나 0으로 나누기를 방지하도록 설계되었습니다
- `#REF!` 또는 `#DIV/0!` 오류가 발생하면 수식을 확인하세요

---

## 🔧 수식 최적화 버전 (더 안전함)

각 열별로 더 안전하고 최적화된 버전:

### H열 (최적화 버전)
```excel
=ARRAYFORMULA(IF((ROW(C3:C)<=2)+(C3:C=""), "", IF(INDEX(C:C, ROW(C3:C)-1)=0, "", C3:C/INDEX(C:C, ROW(C3:C)-1)-1)))
```

### O열 (최적화 버전)
```excel
=ARRAYFORMULA(IF(ROW(B10:B)<=9, "", IF((B10:B="")+(K10:K=""), "", B10:B+K10:K)))
```

### P열 (최적화 버전)
```excel
=ARRAYFORMULA(IF(ROW(C2:C)<=1, "", IF((C2:C="")+(L2:L=""), "", C2:C+L2:L)))
```

### Q열 (최적화 버전)
```excel
=ARRAYFORMULA(IF((ROW(O3:O)<=2)+(O3:O=""), "", IF(INDEX(O:O, ROW(O3:O)-1)=0, "", O3:O/INDEX(O:O, ROW(O3:O)-1)-1)))
```

### S열 (최적화 버전)
```excel
=ARRAYFORMULA(IF((ROW(P14:P)<=13)+(P14:P=""), "", IF(INDEX(P:P, ROW(P14:P)-1)=0, "", P14:P/INDEX(P:P, ROW(P14:P)-1)-1)))
```

### U열 (최적화 버전)
```excel
=ARRAYFORMULA(IF(ROW(AA2:AA)<=1, "", IF((AA2:AA="")+(X2:X="")+(X2:X=0), "", AA2:AA/X2:X)))
```

---

## 📊 비교: Apps Script vs ARRAYFORMULA

| 항목 | Apps Script | ARRAYFORMULA |
|------|-------------|--------------|
| **설치** | Apps Script 에디터 필요 | 수식만 입력 |
| **자동화** | 트리거 설정 가능 | 자동 (수식 기반) |
| **성능** | 대량 데이터에 유리 | 중간 규모까지 유리 |
| **유지보수** | 코드 수정 필요 | 수식 수정 필요 |
| **에러 처리** | 로그 확인 가능 | 수식 오류 표시 |
| **권한** | 스크립트 권한 필요 | 불필요 |

---

## 💡 추천 방법

- **데이터가 1000행 이하**: ARRAYFORMULA 권장 (간단하고 빠름)
- **데이터가 1000행 이상**: Apps Script 권장 (성능 최적화)
- **복잡한 로직 필요**: Apps Script 권장
- **간단한 계산만**: ARRAYFORMULA 권장

---

## 🐛 문제 해결

### 수식이 확장되지 않아요
- ARRAYFORMULA가 올바르게 입력되었는지 확인
- 셀에 텍스트가 아닌 수식이 입력되었는지 확인
- 수식 앞에 `=` 기호가 있는지 확인

### #REF! 오류가 발생해요
- INDEX 함수의 행 번호가 올바른지 확인
- 범위가 시트를 벗어나지 않는지 확인

### #DIV/0! 오류가 발생해요
- 0으로 나누기 방지 로직이 포함되어 있는지 확인
- IF 조건문이 올바르게 작동하는지 확인

---

## 📞 추가 지원

수식 적용 중 문제가 발생하면:
1. Google Sheets의 수식 오류 메시지 확인
2. 각 열의 데이터 형식 확인
3. 필요한 열(B, C, K, L, O, P, X, AA)이 존재하는지 확인
